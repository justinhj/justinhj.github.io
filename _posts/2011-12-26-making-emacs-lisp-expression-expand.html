---
layout: post
title: Making a emacs lisp expression expand itself to XML
date: '2011-12-26T10:32:00.001-08:00'
author: Justin
tags: [emacs-lisp]
modified_time: '2011-12-26T10:43:48.011-08:00'
blogger_id: tag:blogger.com,1999:blog-4777243148323391813.post-3220472187204508366
blogger_orig_url: http://justinsboringpage.blogspot.com/2011/12/making-emacs-lisp-expression-expand.html
---

<div><span>My response to the blog article <a href="http://irreal.org/blog/?p=403" style="background-color: rgb(255, 255, 255); font-family: 'Helvetica Neue', Arial, Helvetica, 'Nimbus Sans L', sans-serif; line-height: 1.3em; text-align: -webkit-auto; ">An Emacs Programming Challenge</a></span></div><div><br /></div><div>The goal is to make the emacs lisp record below execute itself and produce XML. My lisp has gotten rusty so it took me a couple of hours to get this working, but I think I got there...</div><div><br /></div><div>You can see it properly formatted and coloured <a href="http://paste.lisp.org/display/126697">here</a><br /><br /></div>It's fairly straightforward. The only complexity is the use of lexical-let. emacs lisp is dynamically scoped, so in the function I create for each keyword, where it prints the symbol name is a free variable at runtime. So if sym-name is not defined you'll get an error, otherwise you'll get whatever it is defined as instead of the value you wanted.<div><br /></div><div>By using lexical-let any variables are bound lexically, that is stored in an environment that stays with the function we create when it is executed (a closure).<br /><pre>(require 'cl) ;; uses lexical-let<br /><br />(defun make-xml-izer(name)<br /> "Given a symbol NAME this makes a function that outputs an xml string for that<br />symbol and using fset binds it to the same symbol so it becomes executable.<br />This pollutes the global function namespace so be careful with which names you<br />pass in"<br /> (lexical-let ((sym-name name))<br />   (fset (intern name)<br />   (lambda(&amp;rest input)<br />     "returns a string representing the xml encoding of the input sexp"<br />     (let ((res (format "&lt;%s&gt;" sym-name)))<br />       (dolist (item input)<br />  (if (listp item)<br />      (setf res (concat res (eval item)))<br />    (setf res (format "%s%s" res item))))<br />       (setf res (format "%s<!--%s-->" res sym-name))<br />       res)))))<br /><br />;; executing this makes all the symbols in the list below executable <br />(mapcar (lambda(s)<br />   (make-xml-izer<br />    (symbol-name s)))<br /> '(record date millis sequence logger level class method thread emessage exception frame line))<br /><br />;; the sample record<br />(record<br /> (date "2005-02-21T18:57:39")<br /> (millis 1109041059800)<br /> (sequence 1)<br /> (logger nil)<br /> (level 'SEVERE)<br /> (class "java.util.logging.LogManager$RootLogger")<br /> (method 'log)<br /> (thread 10)<br /> (emessage "A very very bad thing has happened!")<br /> (exception<br />   (emessage "java.lang.Exception")<br />   (frame<br />     (class "logtest")<br />     (method 'main)<br />     (line 30))))<br /><br /></pre></div>
