---
layout: post
title: Who changed the line your working on last?
date: '2009-01-08T12:48:00.000-08:00'
author: Justin
tags:
- emacs p4 perforce elisp
modified_time: '2009-01-12T07:52:03.401-08:00'
blogger_id: tag:blogger.com,1999:blog-4777243148323391813.post-388194404855911098
blogger_orig_url: http://justinsboringpage.blogspot.com/2009/01/who-changed-line-your-working-on-last.html
---

My team use Perforce for version control, and I recently wrote an implementation of  'blame', also known as 'praise'. When editing a file that is in Perforce, I can run p4-blame, and it will figure out the last change list that this file, and the line that point is on, was changed. It then opens a buffer containing that change list. This is often useful while working, and is so fast when accessed from the editor, it makes it trivial to do.<br /><br />First, I wanted it to open two buffers, one with the annotated file (the file you're working on with the change list number at the start of each line), and another with the changelist you're interested in. When running the command multiple times I want these buffers to be deleted. So I added a helper function that creates a named buffer, and if it exists already, makes sure it is empty.<br /><br /><pre><br />(defun get-buffer-create-and-clear(name)<br />  (interactive "sName: ")<br />  (let ((buffer (get-buffer-create name)))<br />    (goto-line 1 buffer)<br />    (erase-buffer)<br />    buffer))<br /></pre><br /><br />Ok now for the blame code. As you can see, mostly what it's doing is called the P4 command line and passing the output to buffers. Firstly I call annotate to get the change list numbered lines. Then I go to that file and go to the same line that point was at. (number-at-point) returns that number. Finally I call p4 describe to get the changelist information.<br /><br /><pre><br />(defun p4-blame()<br />  "blame the current line of code... it seeks out the change list of the last person<br />to change this line. The arguments to annotate, which dumps the source file with the <br />change list number it was last altered in, are q (no header) i (follow branches) and<br />c for change numbers rather than revision numbers."<br />  (interactive)<br />  (let* ((line (line-number-at-pos))<br />  (source-file (buffer-file-name))<br />  (annotate-buffer (get-buffer-create-and-clear "*p4-annotate*")))<br />    (shell-command (format "p4.exe annotate -q -i -c %s" source-file) annotate-buffer)<br />    (goto-line line annotate-buffer)<br />    (let ((change-number (number-at-point)))<br />      (if change-number<br />   (let ((blame-buffer (get-buffer-create-and-clear "*p4-blame*")))<br />     (shell-command (format "p4.exe describe %d" change-number) blame-buffer))<br /> (message "error: could not get change list number for line %d" line)))))<br /><br /></pre><br /><br />The error detection is a bit sloppy here. I don't know how to figure out if the shell-command failed. But it's not a big deal because if you do this in a file that is not in P4 then it will simply print a message saying could not get change list. <br /><br />Ideally I could send the error output to a buffer, and then parse it to see if it's empty.