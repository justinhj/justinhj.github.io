---
layout: post
title: Finding duplicate files in a dired buffer
date: '2011-06-01T21:31:00.000-07:00'
author: Justin
tags: [emacs, dired, emacs-lisp]
modified_time: '2011-06-01T22:40:49.421-07:00'
thumbnail: http://3.bp.blogspot.com/-FpO96rrdz0E/TecTVZCglII/AAAAAAAAFg0/3PT00loebT4/s72-c/twins.jpg
blogger_id: tag:blogger.com,1999:blog-4777243148323391813.post-5738307875096175125
blogger_orig_url: http://justinsboringpage.blogspot.com/2011/06/finding-duplicate-files-in-dired-buffer.html
---

<a href="http://3.bp.blogspot.com/-FpO96rrdz0E/TecTVZCglII/AAAAAAAAFg0/3PT00loebT4/s1600/twins.jpg" onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}"><img style="cursor:pointer; cursor:hand;width: 320px; height: 244px;" src="http://3.bp.blogspot.com/-FpO96rrdz0E/TecTVZCglII/AAAAAAAAFg0/3PT00loebT4/s320/twins.jpg" border="0" alt="" id="BLOGGER_PHOTO_ID_5613476718760203394" /></a><br /><div><br /></div><div>picture by <a href="http://www.flickr.com/photos/donaldmacleod/3439612846/">Donald MacLeod</a></div><div><br /></div><div>This is a an example of programming emacs in emacs-lisp just to give an idea of what you can put together in an hour or two. I was looking at a dired buffer with a bunch of photos in, and some were the same photo that I'd downloaded twice. So I started thinking about writing a utility in emacs to automatically find and remove the duplicate files. In this post I'll just show the code for finding the files and display their filenames in a buffer. </div><div><br /></div><div>I've put the <a href="http://code.google.com/p/justinhj-emacs-utils/source/browse/trunk/duplicates.el">source</a> on google code.</div><div><br /></div><div>After downloading you can load the source into emacs and call `eval-buffer', then open up a dired buffer to try it out. For this to be useful you need some duplicated files, so make some if you need to. </div><div><br /></div><div>Mark the files you want to check for duplicates. For example to mark all jpg files you would type %m to mark files matching a regexp and type .*\.jpg</div><div><br /></div><div>Now execute the command `dired-show-marked-duplicate-files' and after a short delay (in my test 80 jpg photos took about 5 seconds) you'll see a buffer called 'Duplicated files' which contains a list of the files which have the same contents. </div><div><br /></div><div>Next steps for this little project will be to give you an interactive way to delete the duplicated files. I haven't decided quite how I'd like that to work, drop me an email if you have an idea. I've been thinking about perhaps resetting which files are marked so that only the duplicates are marked. At that point you can then hit R to move them to another spot, or delete them with x.</div><div><br /></div><div>Now some comments about the code involved...</div><div><br /></div><div>Most of the work is done in the function dired-show-marked-duplicate-files. First line "  (interactive)" makes it an interactive function, meaning the user of emacs can invoke it. </div><div><br /></div><div> "(if (eq major-mode 'dired-mode)" will check that we're in the right kind of buffer, because it makes no sense to run this in another mode. </div><div><br /></div><div>In order to find the duplicate files I just need to walk the list of marked files, generate the md5 value of the contents of each one and add it to hash table. The keys in the hash table will be the md5, and the values will be a list of files with that md5. Once we've done that, finding duplicates is a simple matter of walking the hash table keys and displaying any where the value has multiple entries.</div><div><br /></div><div>"(let ((md5-map (make-hash-table :test 'equal :size 40)))" Creates the hash table, making sure we use 'equal to match our filenames.</div><div><br /></div><div><div>"(let ((filenames (dired-get-marked-files)))" this gets the marked files as a list of filenames</div><div><br /></div><div>The next little bit of code is just to store the item in the hash table after getting the md5. There's no function in emacs to get the md5 of a file, but you can get the md5 of a string, so I wrote a helper function for getting the contents of a file into a temporary buffer first. </div></div><div><br /></div><div><div>(defun md5-file(filename)</div><div>  "Open FILENAME, load it into a buffer and generate the md5 of its contents"</div><div>  (interactive "f")</div><div>  (with-temp-buffer </div><div>    (insert-file-contents filename)</div><div>    (md5 (current-buffer))))</div></div><div><br /></div><div>Finally I want to display the results, so I create a buffer and then use maphash (walks the keys of a hash table executing a function on each) with a helper function `show-duplicate' which simply writes the values of the hash table entry into that buffer. </div>
